# hosts/whio-vm/default.nix
{
  pkgs
  , specialArgs
  , ...
}:
let
  # Destructure 'hostname' from the specialArgs passed from flake.nix
  inherit (specialArgs) hostname username;
in
{

  imports = [
    # Host specific configuration
    ./hardware-configuration.nix
    ./persistence.nix                         # Preservation configuration

    # Basic configuration
    ../../lib/nixos/base-packages.nix
    ../../lib/nixos/base-security.nix
    ../../lib/nixos/hardware-services.nix
    ../../lib/nixos/hyprland-services.nix
    ../../lib/nixos/multimedia.nix
    ../../lib/nixos/virtualisation.nix
    ../../lib/nixos/zram.nix
  ];

  hardware.graphics = {
    enable = true;
    enable32Bit = true;
    extraPackages = with pkgs; [
      mesa
    ];
  };

  environment.systemPackages = with pkgs; [
    spice-vdagent
    xdg-desktop-portal
    xdg-desktop-portal-gtk
    impala
  ];

  # Time and locale are specific to the physical location
  time.timeZone = "Pacific/Auckland";
  i18n.defaultLocale = "en_NZ.UTF-8";
  
  networking = {
    hostName = hostname;
    networkmanager.enable = false;
    wireless.iwd.enable = true;
  };

  services = {
    # Input
    libinput.enable = true;
    # Virtualisation Guests
    qemuGuest.enable = true;
    spice-vdagentd.enable = true;
    # Hardware
    udev.enable = true;
    power-profiles-daemon.enable = true;
    blueman.enable = true; # Bluetooth
    # Printing
    printing.enable = true;
    # Discovery
    avahi.enable = true;
    # BTRFS Snapshots
    snapper = {
      enable = true;
      configs.root = {
        subvolume = "/";
        extraConfig = {
          TIMELINE_CREATE = "no";
          NUMBER_CLEANUP = "yes";
          NUMBER_MIN_AGE = "1800";
          NUMBER_LIMIT = "25";
          NUMBER_LIMIT_IMPORTANT = "10";
        };
      };
    };
  };

  users = {
    users.${username} = {
      home = "/home/${username}";
      isNormalUser = true;
      # Add host-specific groups. This list is merged with 'wheel' from configuration.nix.
      extraGroups = [ "wheel" "users" "video" username ];
      # generated by `mkpasswd -m scrypt --rounds=11`
      initialHashedPassword = "$7$GU..../....S9EPW0eEM5JL4uh1Bo1yr/$bDP2HRn7G8LV8jLV2yj3DQHJJPE0svzRh0Q2fEPePN9";
    };
    users.root.initialHashedPassword = "$7$GU..../....S9EPW0eEM5JL4uh1Bo1yr/$bDP2HRn7G8LV8jLV2yj3DQHJJPE0svzRh0Q2fEPePN9";
  };

}
